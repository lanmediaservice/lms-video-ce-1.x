ВНИМАНИЕ! Проводить обновление до выхода исправления работы поступлений пока не рекомендуется!


I. Системные требования.
    ОС: Linux, FreeBSD, Windows
    Вебсервер: Apache, nginx
    PHP: 5.3 с поддержкой mbstring, iconv, mcrypt, mysql, hash, session, gd, dom, bcmath, ctype, json, simplexml
    MySQL: 5.0 и выше

II. Обновление скрипта видео-каталога с версии 1.0 до 1.2
    
1. Скачать дистрибутив версии 1.2

2. Распаковать файлы подкаталога video/ поверх рабочей версии.

3. Переименовать файл /app/local.settings.dist.php в local.settings.php

4. Если в рабочей версии используется logon.php с шифрованием cookies, то 
   шифрование также нужно настроить в файле local.settings.php

5. Добавить в config.php:
/**
 * Настройки отображения ссылок в шаблоне modern
 */
//какие ссылки пользователь может включать/отключать:
$config['download']['selectable'] = array('smb'=>true, 'dcpp'=>true, 'ed2k'=>true);
//установки по-умолчанию
$config['download']['defaults'] = array('smb'=>true, 'dcpp'=>true, 'ed2k'=>true);
//какие плейлисты может выбирать пользователь:
$config['download']['players']['selectable'] = array('la'=>false, 'mp'=>true, 'mpcpl'=>true, 'bsl'=>true, 'crp'=>true, 'tox'=>true, 'kaf'=>true, 'pls'=>true, 'xspf'=>true);
//плейлист по-умолчанию:
$config['download']['players']['default'] = 'xspf'; 

6. Изменить шаблон в config.php:
   $config['template'] = 'modern';

7. Для большей безопасности убедиться, что каталог http://mysite.com/video/app/ 
   не доступен через браузер.

8. Открыть в браузере каталог http://mysite.com/video/update/ и провести обновление базы данных

9. Удалить каталоги install/ и update/

10. Убедится, что скрипт периодического обслуживания индекса поиска, отбора бестселлеров работает:
   /app/tasks/batch-daily.sh или /app/tasks/batch-daily.bat

   и добавить его в crontab (Unix):
   0 5 * * * /path/to/video/app/tasks/batch-daily.sh 2>&1 >/dev/null

   или в планировщик Windows (запуск 1 раз в сутки или по желанию):
   c:\www\video\app\tasks\batch-daily.bat
    

11. Убедится, что скрипт генерации кадров и информации о файлах, парсинга 
   персоналий работает (первый запуск может занять очень много времени):
    /app/tasks/batch-5m.sh или /app/tasks/batch-5m.bat

    и добавить его в crontab (Unix):
    */5 * * * * /path/to/video/app/tasks/batch-5m.sh 2>&1 >/dev/null

    или в планировщик Windows (каждые 5 минут или по желанию):
    c:\www\video\app\tasks\batch-5m.bat

    Примечание: для Windows в файле php.bat необходимо прописать полный путь к php.exe

12. Для того, чтобы фото персоналий выглядели лучше (в шаблоне modern они 
    увеличены с 60 до 90 пикселей), необходимо перезакачать все персоналии.
    Для этого нужно выполнить в БД запрос:

    UPDATE `persones` SET `updated_at`='0000-00-00 00:00:00' WHERE `url`!='';

    Персоналии обновятся автоматически при выполнении скрипта batch-5m.sh/batch-5m.bat

Частые проблемы после обновления:
    1. В IE 8/9 выдается ошибка "Не удалось завершить действие. Ошибка c00ce56e.".
    Причина: необходимо на сервере указать кодировку. Для Apache:

        AddDefaultCharset windows-1251

    Для nginx:

        charset windows-1251;

    2. Не отображаются бестселлеры. Живой поиск не работает.
    Причина: Не выполнен п.11 данной инструкции.


    3. Содержание вкладки "Бестселлеры" не меняется, хотя п.11 анной инструкции выполнен (и скрипт запускается по расписанию).
    Причина: параметр config.php $config['hitmethod'] установлен в 1 или 3 (в этих режимах бестселлеры не обновляются)



III. Обновление скрипта видео-каталога с версии 1.1 до 1.2
    
1. Скачать дистрибутив версии 1.2

2. Распаковать файлы подкаталога video/ поверх рабочей версии.

3. Открыть в браузере каталог http://mysite.com/video/update/ и провести обновление базы данных

4. Удалить каталоги install/ и update/

5. Убедится, что скрипт генерации кадров и информации о файлах, парсинга 
   персоналий работает (первый запуск может занять очень много времени):
    /app/tasks/batch-5m.sh или /app/tasks/batch-5m.bat

    и добавить его в crontab (Unix):
    */5 * * * * /path/to/video/app/tasks/batch-5m.sh 2>&1 >/dev/null

    или в планировщик Windows (каждые 5 минут или по желанию):
    c:\www\video\app\tasks\batch-5m.bat

    Примечание: для Windows в файле php.bat необходимо откорректировать полный путь к php.exe


